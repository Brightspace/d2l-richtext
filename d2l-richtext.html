<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../s-html/s-html.html">

<!--
	@demo demo/d2l-richtext.html
-->
<dom-module id="d2l-richtext">
	<template>
		<s-html html="[[_processedRichtext]]"></s-html>
	</template>

	<script>
		'use strict';
		Polymer({
			is: 'd2l-richtext',
			properties: {
				richtext: {
					observer: '_onRichTextChanged',
					type: String
				},
				_processedRichtext: String,
				quicklinkConsumer: {
					type: String,
					default: null
				},
				imageConsumer: {
					type: String,
					default: null
				},
				getToken: Function
			},
			listeners: {
				'get-token': '_onGetTokenRequest'
			},
			ready: function() {
				this._onRichTextChanged(this.richtext);
			},
			_onGetTokenRequest: function(e) {
				e.stopPropagation();
				if (this.getToken && e.detail.callback) {
					this.getToken().then(function(token) {
						e.detail.callback(token);
					});
				}
			},
			_onRichTextChanged: function(richtext) {
				if (!richtext) {
					return;
				}
				this._processedRichtext = this._replaceConsumers({
					'd2l-richtext-quicklink': this.quicklinkConsumer,
					'd2l-richtext-image': this.imageConsumer
				}, richtext);
			},
			_replaceConsumers: function(consumerMap, richtext) {
				var curVal = richtext;
				Object.keys(consumerMap).forEach(function(key) {
					if (consumerMap[key]) {
						var regex = new RegExp('(</? ?)' + key, 'g');
						curVal = this._replaceIfProviderGiven(regex, consumerMap[key], richtext);
					}
				}.bind(this));
				return curVal;
			},
			_replaceIfProviderGiven: function(tagName, provider, richtext) {
				if (!provider) {
					return richtext;
				}
				function replace(str, tagStart) {
					return tagStart + provider;
				}
				return richtext.replace(tagName, replace);
			}
		});
	</script>
</dom-module>
